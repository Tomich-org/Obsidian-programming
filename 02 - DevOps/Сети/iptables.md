# Основа
iptables - это программа для управления правилами файрвола в ядре Linux. Она предоставляет интерфейс для управления сетевыми правилами, фильтрацией пакетов, NAT (Network Address Translation) и другими функциями, связанными с сетевой безопасностью и маршрутизацией. Вот несколько ключевых аспектов, связанных с iptables:

1. **Таблицы (Tables):** iptables использует несколько таблиц для хранения правил, каждая из которых предназначена для определенного вида функций:    
    - **filter:** Это таблица по умолчанию, которая используется для фильтрации пакетов. Здесь определяются правила для принятия, отклонения или отбрасывания пакетов.
    - **nat:** Эта таблица используется для настройки Network Address Translation (NAT). Она позволяет изменять адреса и порты пакетов при их прохождении через маршрутизатор.
    - **mangle:** Эта таблица используется для изменения заголовков пакетов.
    - **raw:** Эта таблица предоставляет возможность наложения специальных правил на пакеты до их обработки другими таблицами.
2. **Цепочки (Chains):** В каждой таблице существует набор цепочек, через которые проходят пакеты перед принятием решения о том, что с ними делать. Некоторые из основных цепочек в таблице filter:    
    - **INPUT:** Применяется ко входящим пакетам.
    - **OUTPUT:** Применяется к исходящим пакетам.
    - **FORWARD:** Применяется к пакетам, которые маршрутизируются через систему.
3. **Правила (Rules):** Правила определяют действия, которые должны быть выполнены с пакетами, соответствующими определенным критериям. Каждое правило состоит из условия (набора совпадений) и действия (что делать с пакетом при совпадении с условиями).    
4. **Таргеты (Targets):** Таргеты указывают на действия, которые должны быть выполнены с пакетами при совпадении с правилами. Некоторые из основных таргетов включают ACCEPT (принять пакет), DROP (отбросить пакет), REJECT (отклонить пакет с отправкой сообщения об ошибке), и REDIRECT (перенаправить пакет на другой порт или адрес).    
5. **Управление правилами:** Вы можете добавлять, удалять и изменять правила с помощью команды `iptables`. Правила обычно применяются в реальном времени, но их также можно сохранить в файле и загрузить в систему при загрузке.    
6. **Состояния соединений:** iptables также может управлять пакетами на основе их состояний соединения. Это позволяет контролировать, какие типы трафика разрешены или блокируются в рамках активного сеанса связи.    

Использование iptables позволяет администраторам сетей настраивать файрволы и маршрутизацию пакетов, обеспечивая безопасность и эффективность сети.
# Опции
Общий формат команды:
```bash
iptables [-t TABLE] -A|D|I|R|F|L|P CHAIN [MATCH] -j TARGET
```
## Основные параметры:
- `-t TABLE` — указывает таблицу (по умолчанию `filter`).
- `-A CHAIN` — добавить правило в конец цепочки.
- `-D CHAIN RULE_NUM` — удалить правило из цепочки.
- `-I CHAIN RULE_NUM` — вставить правило на указанное место.
- `-R CHAIN RULE_NUM` — заменить правило.
- `-F CHAIN` — очистить цепочку.
- `-L CHAIN` — вывести список правил.
- `-P CHAIN TARGET` — установить политику цепочки (`ACCEPT`, `DROP`).
## Основные таблицы (`-t TABLE`)

|Таблица|Описание|
|---|---|
|`filter`|Фильтрация пакетов (по умолчанию)|
|`nat`|Преобразование сетевых адресов (SNAT, DNAT, MASQUERADE)|
|`mangle`|Изменение заголовков пакетов|
|`raw`|Исключение пакетов из connection tracking|
|`security`|SELinux-политики (используется редко)|
пример:
```bash
iptables -t nat -L -v
```
(Выведет NAT-правила).
## Основные цепочки (`CHAIN`)

|Цепочка|Описание|
|---|---|
|`INPUT`|Обрабатывает входящий трафик на локальный хост|
|`OUTPUT`|Обрабатывает исходящий трафик с хоста|
|`FORWARD`|Обрабатывает транзитный трафик (если сервер маршрутизирует пакеты)|
|`PREROUTING`|Меняет пакеты перед маршрутизацией (`nat`, `mangle`)|
|`POSTROUTING`|Меняет пакеты перед отправкой (`nat`, `mangle`)|
Пример:
```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```
(Разрешает SSH на локальный хост).
## Опции для фильтрации трафика
### Типы протоколов (`-p PROTOCOL`)
```bash
iptables -A INPUT -p tcp -j ACCEPT 
iptables -A INPUT -p udp -j ACCEPT 
iptables -A INPUT -p icmp -j ACCEPT
```
Протоколы: `tcp`, `udp`, `icmp`, `all`.
### Фильтрация по IP (`-s`, `-d`)
- `-s` (source) — источник пакета.
- `-d` (destination) — получатель пакета.
Примеры:
```bash
iptables -A INPUT -s 192.168.1.100 -j ACCEPT   # Разрешить трафик от 192.168.1.100 iptables -A OUTPUT -d 8.8.8.8 -j DROP         # Запретить выход на 8.8.8.8
```
### Фильтрация по портам (`--sport`, `--dport`)
Работает только с `-p tcp` или `-p udp`.
```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT   # Разрешить SSH 
iptables -A INPUT -p tcp --sport 80 -j ACCEPT   # Разрешить входящий HTTP-ответ
```
Диапазон портов:
```bash
iptables -A INPUT -p tcp --dport 1000:2000 -j ACCEPT
```
### Состояния соединений (`-m state`)
Используется для работы с уже установленными соединениями.
```bash
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```
**Объяснение состояний:**
- `NEW` — новый пакет, не связанный с существующим соединением.
- `ESTABLISHED` — ответ на уже установленное соединение.
- `RELATED` — пакет, связанный с уже установленным соединением (например, FTP).
### Фильтрация по интерфейсам (`-i`, `-o`)
- `-i` (interface) — входной интерфейс.
- `-o` (output) — выходной интерфейс.

Примеры:
```bash
iptables -A INPUT -i eth0 -j ACCEPT   # Разрешить всё с eth0 
ptables -A OUTPUT -o wlan0 -j DROP   # Блокировать всё с wlan0
```
### Лимит пакетов (`-m limit`)
Защита от DDoS:
```bash
iptables -A INPUT -p icmp -m limit --limit 1/s -j ACCEPT
```
(Разрешает не более 1 ICMP-запроса в секунду).
### Логирование (`-j LOG`)
Логирует пакеты перед обработкой.
```bash
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH ATTEMPT: "
```
### Проброс портов (DNAT, SNAT)
Пример NAT:
```bash
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:8080
```
(Перенаправляет HTTP-запросы на локальный сервер 192.168.1.10:8080).
## Примеры правил
### Базовый файрволл для сервера
```bash
iptables -P INPUT DROP        # Блокируем всё 
iptables -P FORWARD DROP 
iptables -P OUTPUT ACCEPT     # Разрешаем исходящий трафик  
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT iptables -A INPUT -p tcp --dport 22 -j ACCEPT    # Разрешаем SSH 
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # Разрешаем HTTP 
iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # Разрешаем HTTPS 
iptables -A INPUT -p icmp -j ACCEPT             # Разрешаем ping
```
### NAT (Маршрутизация интернета через сервер)
```bash
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE echo 1 > /proc/sys/net/ipv4/ip_forward
```
(Включает NAT и маршрутизацию).
# Основные команды
**Посмотреть текущие правила**:
```bash
iptables -L -v -n
```
Опции:
- `-L` - вывести список правил
- `-v` - показать подробности (интерфейсы, счетчик пакетов)
- `-n` - не пытаться резолвить IP-адреса в имена

**Открыть доступ к 80 порту (HTTP):**
```bash
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```

**Блокировать весь входящий SSH (порт 22):**
```bash
iptables -A INPUT -p tcp --dport 22 -j DROP
```

**Разрешить всё от конкретного IP:**
```bash
iptables -A INPUT -s 192.168.1.100 -j ACCEPT
```

**Удалить правило:**
```bash
iptables -D IPUT -p tcp --dport 80 -j ACCEPT
```

**Сохранить конфигурации после перезапуска:**
```bash
iptables-save > /etc/iptables.rules
iptables-restore < /etc/iptables.rules
```
